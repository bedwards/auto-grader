{% extends "base.html" %}

{% block content %}
<h1>Create Auto-Graded Assignment</h1>
<p>Configure AI-powered grading for this assignment</p>

<form id="attachmentForm">
    <div class="form-group">
        <label for="rubric">Grading Rubric (JSON format):</label>
        <textarea id="rubric" name="rubric" placeholder='{"criteria": [{"name": "Content", "points": 50}, {"name": "Organization", "points": 30}, {"name": "Grammar", "points": 20}]}'></textarea>
        <small style="color: #666; display: block; margin-top: 5px;">Define your grading criteria in JSON format</small>
    </div>
    
    <div class="form-group">
        <label for="gradeLevel">Grade Level:</label>
        <select id="gradeLevel" name="gradeLevel">
            <option value="elementary">Elementary School</option>
            <option value="middle">Middle School</option>
            <option value="high" selected>High School</option>
            <option value="college">College</option>
        </select>
    </div>
    
    <div class="form-group">
        <label>
            <input type="checkbox" id="autoGrade" name="autoGrade" checked>
            Automatically grade when students submit
        </label>
    </div>
    
    <div class="form-group">
        <label>
            <input type="checkbox" id="constructiveFeedback" name="constructiveFeedback" checked>
            Provide constructive feedback
        </label>
    </div>
    
    <button type="submit" class="button">Create Attachment</button>
    <button type="button" class="button secondary" onclick="closeAddonIframe()">Cancel</button>
</form>

<div id="status" class="message" style="display: none;"></div>

<script>
const itemId = '{{ item_id }}';
const itemType = '{{ item_type }}';
const courseId = '{{ course_id }}';

document.getElementById('attachmentForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const status = document.getElementById('status');
    status.className = 'message info';
    status.textContent = 'Creating attachment...';
    status.style.display = 'block';
    
    try {
        const rubric = JSON.parse(document.getElementById('rubric').value || '{}');
        const gradeLevel = document.getElementById('gradeLevel').value;
        const autoGrade = document.getElementById('autoGrade').checked;
        const constructiveFeedback = document.getElementById('constructiveFeedback').checked;
        
        const response = await fetch('/api/create-attachment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                courseId,
                itemId,
                rubric,
                gradeLevel,
                autoGrade,
                constructiveFeedback
            })
        });
        
        if (response.ok) {
            status.className = 'message success';
            status.textContent = 'Attachment created successfully!';
            setTimeout(() => closeAddonIframe(), 2000);
        } else {
            throw new Error('Failed to create attachment');
        }
    } catch (error) {
        status.className = 'message error';
        status.textContent = `Error: ${error.message}`;
    }
});

function closeAddonIframe() {
    window.parent.postMessage({
        type: 'Classroom',
        action: 'closeIframe',
    }, '*');
}
</script>
{% endblock %}
